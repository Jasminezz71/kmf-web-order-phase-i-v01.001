@model ZEN.SaleAndTranfer.VM.MAS.DoVM

@{
    ViewBag.Title = "ReceiveItem";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var url1 = string.Empty;
}

@*<style>
    .font-normal {
        font-weight: normal;
    }

    /* Supaneej, 2018-10-11, Style for zoom item image */
    * {
        box-sizing: border-box;
    }

    .zoom {
        transition: transform .2s;
        width: 200px;
        height: 200px;
        margin: 0 auto;
    }

        .zoom:hover {
            -ms-transform: scale(1.5); /* IE 9 */
            -webkit-transform: scale(1.5); /* Safari 3-8 */
            transform: scale(8.0);
        }
</style>*@

@Html.Partial("_MessagePartial", Model.MessageList)

<form class="form-horizontal" id="form1">
    @Html.HiddenFor(m => m.doVM_MA.ST_DO_CODE)
    @Html.HiddenFor(m => m.doVM_MA.ST_PR_CODE)
    @Html.HiddenFor(m => m.doVM_MA.resultList[0].LOCATION_CODE)
    <div class="container">
        <h2>
            หน้าจอใบเตรียมรับสินค้า : <small>ทำรับสินค้า</small>
        </h2>

        <hr />

        <div class="panel panel-primary">
            <div class="panel-heading">รายชื่อสินค้า</div>
            <div class="panel-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="col-md-6 control-label">เลขที่ใบตลาด (PR)</label>
                            @Html.HiddenFor(m => m.doVM_MA.ST_PR_CODE)
                            <label class="col-md-6 control-label font-normal" style="text-align: left;">@Model.doVM_MA.ST_PR_CODE</label>
                        </div>
                        <div class="form-group">
                            <label class="col-md-6 control-label">เลขที่ใบเตรียมรับสินค้า (DO)</label>
                            @Html.HiddenFor(m => m.doVM_MA.ST_DO_CODE)
                            <label class="col-md-6 control-label font-normal" style="text-align: left;">@Model.doVM_MA.ST_DO_CODE</label>
                            @*<div class="col-sm-9">
                                @if (Model.doVM_MA.doList != null)
                                    {
                                        @Html.DropDownListFor(m => m.doVM_MA.ST_DO_CODE,
                                        new SelectList(@Model.doVM_MA.doList, "ITEM_VALUE", "ITEM_TEXT")
                                        , new
                                        {
                                            @class = "form-control"
                                          ,
                                            @onchange = "onChangeDOCode(this);"
                                        })
                                    }
                                                    </div>*@
                            @*<label class="col-md-3 control-label font-normal" style="text-align: left;">@Model.doVM_MA.ST_DO_CODE</label>*@
                        </div>
                        <div class="form-group">
                            <label class="col-md-6 control-label">Location</label>
                            <label class="col-md-6 control-label font-normal" style="text-align: left;">@Model.doVM_MA.resultList[0].LOCATION_CODE</label>
                        </div>
                        <div class="form-group">
                            <label class="col-md-6 control-label">วันที่สร้างใบตลาด</label>
                            @Html.HiddenFor(m => m.doVM_MA.CREATE_DATE)
                            <label class="col-md-6 control-label font-normal" style="text-align: left;">
                                @if (Model.doVM_MA.CREATE_DATE.HasValue)
                                {
                                    @Model.doVM_MA.CREATE_DATE.Value.ToShortDateString()
                                }
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="col-md-6 control-label">วันกำหนดส่งสินค้า</label>
                            @Html.HiddenFor(m => m.doVM_MA.PLAN_DELIVERY_DATE)
                            <label class="col-md-6 control-label font-normal" style="text-align: left;">
                                @if (Model.doVM_MA.PLAN_DELIVERY_DATE.HasValue)
                                {
                                    @Model.doVM_MA.PLAN_DELIVERY_DATE.Value.ToShortDateString()
                                }
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="col-md-6 control-label">*วันที่ทำรับสินค้า</label>
                            <div class="col-sm-6">
                                @Html.TextBoxFor(m => m.doVM_MA.RECEIVE_DATE, Model.DT_SHORT_FORMAT, new { @class = "form-control , datepicker" })
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-md-6 control-label">*หมายเลขอ้างอิง</label>
                            <div class="col-sm-6">
                                @Html.TextBoxFor(m => m.doVM_MA.REFERANCE_NO, new { @class = "form-control", maxlength = 50 })
                            </div>
                            @*<div class="col-sm-6">
                                    <span class=" pull-right">
                                        @if (Model.doVM_MA.ST_DO_CODE != null && Model.doVM_MA.ST_DO_CODE != "")
                                        {
                                            @Html.ActionLink("พิมพ์ใบเตรียมรับสินค้า", "RPT_ST_REPORT", "/RPT/Report"
                                                                                 , new
                                                                                 {
                                                                                     @P_ST_DO_CODE = Model.doVM_MA.ST_DO_CODE
                                                                                 }
                                                                                 , new { @class = "reportDoDialog btn btn-primary" })
                                        }
                                        &nbsp;
                                        <input type="button" class="btn btn-primary" value="บันทึก" onclick="gotoSave();" />
                                        &nbsp;
                                        <input type="button" class="btn btn-primary" value="ล้างหน้าจอ" onclick="gotoClear();" />
                                    </span>

                                    <div id="dialog-report-do" style="display: none">
                                        <input class="hide" id="btnClosePopupDo" type="button" />
                                    </div>
                                </div>*@
                        </div>
                        <div class="form-group">
                            <label class="col-md-6 control-label">*ชื่อผู้รับของ</label>
                            <div class="col-sm-6">
                                @Html.TextBoxFor(m => m.doVM_MA.RECEIVE_BY, new { @class = "form-control" })
                            </div>


                        </div>
                        <div class="form-group">
                            <label class="col-md-6 control-label">*สถานะใบเตรียมรับสินค้า (DO)</label>
                            <div class="col-md-6">
                                @if (Model.doVM_MA.DO_STATUS_CODE != null)
                                {
                                    @Html.DropDownListFor(m => m.doVM_MA.DO_STATUS_CODE,
                                     new SelectList(@Model.doVM_MA.doStatusCode, "ITEM_VALUE", "ITEM_TEXT")
                                , new { @class = "form-control" }
                                )
                                }
                            </div>
                        </div>

                    </div>


                    @* จะเพิ่มหน้าจอ Complaint *@
                    @Html.Partial("_GrComplainPartial", Model)


                    <div class="col-md-12">
                        <span class=" pull-right" style="margin-top:10px;margin-bottom:10px">
                            @*<input type="button" class="btn btn-primary" value="พิมพ์ใบเตรียมรับสินค้า (DO)" onclick="gotoSearch();" />
                                &nbsp;*@
                            @if (Model.doVM_MA.ST_DO_CODE != null && Model.doVM_MA.ST_DO_CODE != "")
                            {
                                @Html.ActionLink("พิมพ์ใบเตรียมรับสินค้า", "RPT_ST_REPORT_EQ", "/RPT/Report"
                                                                        , new
                                                                        {
                                                                            @P_ST_DO_CODE = Model.doVM_MA.ST_DO_CODE
                                                                        }
                                                                        , new { @class = "reportDoDialog btn btn-info" })
                            }

                            <input type="button" class="btn btn-primary" value="บันทึก" onclick="gotoSave();" />

                            <input type="button" class="btn btn-default" style="margin-left:50px;" value="ล้างหน้าจอ" onclick="gotoClear();" />
                        </span>

                        <div id="dialog-report-do" style="display: none">
                            <input class="hide" id="btnClosePopupDo" type="button" />
                        </div>
                    </div>

                </div>

                <div class="panel panel-default">
                    <div class="panel-heading">รายชื่อสินค้า</div>
                    <div class="panel-body">
                        <div class="table table-responsive">
                            <table class="table table-hover">
                                <tr>
                                    <th class="text-right">ลำดับ</th>
                                    <th>ประเภทสินค้า</th>
                                    @*<th>สั่งจากแบรนด์</th>*@
                                    <th>รหัสสินค้า</th>
                                    <th>ชื่อสินค้า</th>                                    
                                    <th>รายละเอียดอื่นๆ</th>
                                    @if (Model.showImageFlag)
                                    {
                                        <th>รูปภาพ</th>
                                    }                                 
                                    <th>จำนวนที่สั่ง</th>
                                    <th>หน่วยที่สั่ง</th>
                                    <th>จำนวนที่ส่ง</th>
                                    <th>หน่วยที่ส่ง</th>
                                    <th>จำนวนที่รับแล้ว</th>
                                    <th style="width:100px;">จำนวนที่รับ</th>
                                    <th>หน่วยที่รับ</th>
                                    @*<th>ราคา (บาท)</th>*@
                                    @*<th>หมายเหตุ</th>*@
                                </tr>
                                @for (int i = 0; i < Model.doVM_MA.resultList.Count; i++)
                                {
                                    var item = Model.doVM_MA.resultList[i];
                                    url1 = string.Format("{0}://{1}/{2}", this.Request.Url.Scheme, this.Request.Url.Authority, item.FILE_PATH);
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].ROW_NO)
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].LINE_NO)
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].ST_PR_CATEGORY_NAME)
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].REQUEST_TO_BRAND_CODE)
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].ITEM_CODE)
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].ITEM_NAME_TH)
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].ITEM_NAME_TH2)
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].QTY_REQUEST)
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].REQUEST_UOM_CODE)
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].QTY_SEND)
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].SEND_UOM_CODE)
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].RECEIVE_UOM_CODE)
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].ST_PR_CATEGORY_ID)
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].ST_MAP_WH_ITEM_ID)
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].REQUEST_TO_BRAND_CODE)
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].REQUEST_TO_BRANCH_CODE)
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].REMARK)
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].QTY_RECEIVE_DEFUALT)
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].FILE_PATH)                                    
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].FULL_PATH)
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].SALE_PRICE)
                                    @Html.HiddenFor(m => m.doVM_MA.resultList[i].QTY_RECEIVED)

                                    <tr>
                                        @*<td class="text-right" style="width:20px;">@item.ROW_NO.ToString("#,##0")</td>*@
                                        <td class="text-right" style="width:20px;">@item.ROW_NO</td>
                                        <td>@item.ST_PR_CATEGORY_NAME</td>
                                        @*<td>@item.REQUEST_TO_BRAND_CODE</td>*@
                                        <td>@item.ITEM_CODE</td>
                                        <td>@item.ITEM_NAME_TH</td>
                                        <td>@item.ITEM_NAME_TH2</td>
                                        @if (Model.showImageFlag)
                                        {
                                            <td><img class="zoom" src="@url1" onclick="window.open(src);" border="0" style="width:40px; height:40px;" alt=""></td>
                                        }  
                                        <td>@item.QTY_REQUEST</td>
                                        <td>@item.REQUEST_UOM_CODE</td>
                                        <td>@item.QTY_SEND</td>
                                        <td>@item.SEND_UOM_CODE</td>
                                        <td>@item.QTY_RECEIVED</td>
                                        <td>

                                            @Html.TextBoxFor(m => m.doVM_MA.resultList[i].QTY_RECEIVE,
                                            new
                                            {
                                                @class = "form-control no-copy-paste numberOnly",
                                                //@onkeypress = "return event.charCode >= 48 && event.charCode <= 57"
                                            })
                                        </td>
                                        <td>@item.RECEIVE_UOM_CODE</td>
                                        @*<td class="text-right" style="width:30px;">
                                            @if (item.SALE_PRICE.HasValue)
                                            {
                                                @item.SALE_PRICE.Value.ToString("F2")
                                            }
                                        </td>*@

                                        @*<td>@item.REMARK</td>*@
                                    </tr>
                                }
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <a href="/MAS/Do/Index">กลับไปยังหน้าค้นหา</a>
    </div>
</form>

<script>
    function gotoSave() {
        // ViewBag.msgAlertItemRecieveNotEqualDefault = Item {0} มีการรับสินค้าไม่เท่ากับจำนวนที่มาส่ง ({0} = Item_Code : ITEM_NAME)
        var messageText = '@ViewBag.msgAlertItemRecieveNotEqualDefault';
        var row = parseInt('@Model.doVM_MA.resultList.Count');
        var itemCode = $("#doVM_MA_resultList_0__ITEM_CODE").val();
        var itemName = $("#doVM_MA_resultList_0__ITEM_NAME_TH").val();
        var messageTextArray = [];
        var messageRowArray = parseInt(0);
        //for (var i = 0; i < row; i++) {
        //    if (parseFloat($('#doVM_MA_resultList_' + i + '__QTY_RECEIVE_DEFUALT').val()) != parseFloat($('#doVM_MA_resultList_' + i + '__QTY_RECEIVE').val())) {
        //        var messageTextReplace = messageText.replace('{0}', $('#doVM_MA_resultList_' + i + '__ITEM_CODE').val() + ' : ' + $('#doVM_MA_resultList_' + i + '__ITEM_NAME_TH').val());
        //        messageTextArray[messageRowArray] = messageTextReplace;
        //        messageRowArray++;
        //    }
        //}


        var msgConfirmSave;
        for (var i = 0; i < messageRowArray; i++) {
            if (i == 0) {
                msgConfirmSave = messageTextArray[i];
                msgConfirmSave += '\n';
            }
            else {
                msgConfirmSave += messageTextArray[i];
                msgConfirmSave += '\n';
            }
        }
        if (messageRowArray == 0 || messageRowArray == '0') {
            msgConfirmSave = '@ViewBag.msgConfirmSave';
        }
        else {
            msgConfirmSave += '@ViewBag.msgConfirmSave';
        }
        //if (confirm('@ViewBag.msgConfirmSave')) {
        if (confirm(msgConfirmSave)) {
            var url1 = '@Url.Action("ReceiveItemSave")';
            url1 = url1.substring(0, url1.lastIndexOf("ReceiveItemSave")).concat("ReceiveItemSave");

            var vform = $('#form1');
            vform.attr("action", url1);
            vform.attr("method", "post");
            vform.submit();
        }
        else {
            return false;
        }
    }
    function gotoClear() {
        var url1 = '@Url.Action("ReceiveItem")';
        url1 = url1.substring(0, url1.lastIndexOf("ReceiveItem")).concat("ReceiveItem");

        var vform = $('#form1');
        vform.attr("action", url1);
        vform.attr("method", "post");
        vform.submit();
    }
    function onChangeDOCode(e) {
        var prCode = $('#doVM_MA_ST_PR_CODE').val();
        var doCode = $(e).val();
        var sendPRnDO = doCode.concat('|').concat(prCode);

        var url1 = '@Url.Action("ReceiveItem")';
        url1 = url1.substring(0, url1.lastIndexOf("ReceiveItem")).concat("ReceiveItem/");

        var vform = $('#form1');
        vform.attr("action", url1.concat(sendPRnDO));
        vform.attr("method", "post");
        vform.submit();
    }
    //function openWin(filePath) {
    //    window.open(filePath);
    //}

    /////////////////////////////////////////////////////////////////////////

    // Start DO Dialog //
    $(document).on("click", "#btnClosePopupDo", function (e) {

        $("#dialog-report-do").dialog('close');

    });

    $(document).on("click", ".reportDoDialog", function (e) {

        var url = $(this).attr('href');
        url = url.replace("/MAS", "");
        url = url.replace("?P_ST_DO_CODE=", "/");
        var url1 = url;

        var weightDocument = ($(window).width() * 0.99);
        var higghtDocument = ($(window).height() * 0.8);

        var theDialog = $("#dialog-report-do").dialog({
            title: 'ตัวอย่างก่อนพิมพ์',
            autoOpen: false,
            resizable: false,
            height: higghtDocument,
            width: weightDocument,
            show: { effect: 'drop', direction: "up" },
            modal: true,
            draggable: true,
            open: function (event, ui) {
                $(this).load(url1);
            },
            close: function (event, ui) {
                $('#ifrReport').remove();
                $(this).dialog('close');
            },
            buttons: [
                 {
                     text: "ปิด",
                     "class": 'ClossButtonClass',
                     click: function () {
                         $('#ifrReport').remove();
                         $(this).dialog('close');
                     }
                 }
            ]
        });

        theDialog.dialog("open");
        return false;
    });
    // End PR Dialog //

    /////////////////////////////////////////////////////////////////////////

</script>